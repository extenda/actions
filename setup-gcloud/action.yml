name: Setup gcloud
description: Setup the gcloud CLI and cache it for further use
inputs:
  service-account-key:
    description: |
      The service account key which will be used for authentication.
      The account key should be a base64 encoded JSON key stored as a secret.
    required: true
  version:
    description: Optional gcloud version to install. Defaults to 'latest'.
    required: false
    default: latest
  export-default-credentials:
    description: |
      Export the path to the credentials as `GOOGLE_APPLICATION_CREDENTIALS` to be used in subsequent steps.
      Google Cloud CLIs and APIs will automatically use this environment variable to find credentials.
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Get gcloud latest version
      shell: bash
      run: |
        url="https://dl.google.com/dl/cloudsdk/channels/rapid/components-2.json"
        version=$(curl -s "$url" | grep -o '"version": "[^"]*' | cut -d'"' -f4)
        echo "gcloud_version=$version" >> $GITHUB_ENV

    - name: Cache Gcloud packages
      uses: actions/cache@v3
      id: gcloud-cache
      with:
        key: ${{ runner.os }}-cache-gcloud-${{ env.gcloud_version }}
        path: |
          /opt/hostedtoolcache/gcloud/${{ env.gcloud_version }}

    - uses: extenda/actions/setup-gcloud-base@feat/create-composite-action
      id: gcloud
      with:
        service-account-key: ${{ inputs.service-account-key }}
        version: ${{ inputs.version }}
        export-default-credentials: ${{ inputs.export-default-credentials }}
        cache: steps.gcloud-cache.outputs.cache-hit
