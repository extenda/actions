import fs from 'node:fs';
import path from 'node:path';

import { fileURLToPath } from 'url';

import { modules } from './modules.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const relative = (dir) => {
  const baseDir = path.join(__dirname, '..');
  return path.relative(baseDir, dir);
};

const ifExists = (file, fn) => {
  if (fs.existsSync(file)) {
    fn(file);
  }
};

const generateSonarProperties = async () => {
  const sources = [];
  const tests = [];
  const lcovReportPaths = [];

  await modules.each((dir) => {
    ifExists(relative(path.join(dir, 'src')), (p) => sources.push(p));
    ifExists(relative(path.join(dir, 'test')), (p) => tests.push(p));
    ifExists(relative(path.join(dir, 'coverage', 'lcov.info')), (p) =>
      lcovReportPaths.push(p),
    );
  });

  const properties = `# Generated by 'npm test'
sonar.sourceEncoding=UTF-8
sonar.projectKey=extenda_actions
sonar.projectName=actions
sonar.sources=${sources.join(',')}
sonar.exclusions=**/__mocks__/**,*/dist/**
sonar.tests=${tests.join(',')}
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.testExecutionReportPaths=test-results/sonar-report.xml
sonar.cpd.exclusions=cloud-run/**/*,iam/**/*
`;

  fs.writeFileSync(
    path.join(__dirname, '..', 'sonar-project.properties'),
    properties,
    'utf-8',
  );
};

(async () => {
  console.log('Generate sonar-project.properties');
  await generateSonarProperties();
})();
