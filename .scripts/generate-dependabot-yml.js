const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');
const { modules } = require('./modules');

const generateDependabot = () => {
  const actions = modules.list()
    .map((dir) => path.relative(path.join(__dirname, '..'), dir));

  const dependabot = {
    version: 2,
    updates: [
      {
        'package-ecosystem': 'npm',
        directory: `/`,
        schedule: {
          interval: 'weekly',
        },
        groups: {
          root: {
            patterns: ['*'],
          }
        },
      },
      {
        'package-ecosystem': 'npm',
        directories: actions,
        schedule: {
          interval: 'weekly',
        },
        groups: {
          actions: {
            patterns: ['*'],
          }
        },
      },
      {
        'package-ecosystem': 'github-actions',
        directory: '/',
        schedule: {
          interval: 'weekly',
        },
        groups: {
          workflows: {
            patterns: ['*'],
          },
        },
      },
    ],
  };
  fs.writeFileSync(
    path.join(__dirname, '..', '.github', 'dependabot.yml'),
    `# Generated by .scripts/generate-dependabot-yml.js on 'npm run build'
# DO NOT EDIT THIS FILE

${yaml.dump(dependabot).toString('utf8')}`,
    'utf-8',
  );
};

module.exports = generateDependabot;
