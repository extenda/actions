const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');
const { modules } = require('./modules');

const definition = (directory, groupName) => {
  const def = {
    'package-ecosystem': 'npm',
    directory: `/${directory}`,
    schedule: {
      interval: 'weekly',
    },
    groups: {},
  };
  def.groups[groupName] = {
    patterns: ['*'],
  };
  return def;
};

const generateDependabot = () => {
  const actions = modules.list()
    .map((dir) => path.relative(path.join(__dirname, '..'), dir))
    .map((directory) => definition(directory, path.basename(directory)));

  const dependabot = {
    version: 2,
    updates: [
      definition('', 'root'),
      ... actions,
      {
        'package-ecosystem': 'github-actions',
        directory: '/',
        schedule: {
          interval: 'weekly',
        },
        groups: {
          workflows: {
            patterns: ['*'],
          },
        },
      },
    ],
  };
  fs.writeFileSync(
    path.join(__dirname, '..', '.github', 'dependabot.yml'),
    `# Generated by .scripts/generate-dependabot.yml on 'npm run build'
# DO NOT EDIT THIS FILE

${yaml.dump(dependabot).toString('utf8')}`,
    'utf-8',
  );
};

module.exports = generateDependabot;
