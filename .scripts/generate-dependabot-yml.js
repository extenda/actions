import fs from 'fs';
import yaml from 'js-yaml';
import path from 'path';
import { fileURLToPath } from 'url';

import { modules } from './modules.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// List of deprecated actions that we don't want to waste time bumping dependencies in.
const DEPRECATED_ACTIONS = [
  'cloud-run',
  'docker',
  'kubernetes',
  'test-pod',
  'rs-create-installerpkg',
  'rs-permission-converter',
  'slack-message',
  'txengine-deploy',
];

const generateDependabot = () => {
  const actions = modules
    .list()
    .map((dir) => path.relative(path.join(__dirname, '..'), dir))
    .filter((action) => !DEPRECATED_ACTIONS.includes(action))
    .map((dir) => `/${dir}`);

  const dependabot = {
    version: 2,
    updates: [
      {
        'package-ecosystem': 'npm',
        directory: `/`,
        schedule: {
          interval: 'weekly',
        },
        groups: {
          root: {
            patterns: ['*'],
          },
        },
      },
      {
        'package-ecosystem': 'npm',
        directories: actions,
        schedule: {
          interval: 'weekly',
        },
        groups: {
          actions: {
            patterns: ['*'],
          },
        },
        ignore: [
          // conventional-commits in /utils are not possible to update without major rework.
          { 'dependency-name': 'conventional-changelog-conventionalcommits' },
          { 'dependency-name': 'conventional-changelog-core' },
          { 'dependency-name': 'conventional-commits-parser' },
          { 'dependency-name': 'conventional-recommended-bump' },
          { 'dependency-name': 'git-raw-commits' },

          // camelcase-keys is an ESM from v7
          {
            'dependency-name': 'camelcase-keys',
            versions: ['>= 8'],
          },

          // replace-in-file is an ESM from v6
          {
            'dependency-name': 'replace-in-file',
            versions: ['>= 6'],
          },

          // node-fetch is an ESM from v3
          {
            'dependency-name': 'node-fetch',
            versions: ['>= 3'],
          },

          // chalk is an ESM from v5
          {
            'dependency-name': 'chalk',
            versions: ['>= 5'],
          },
          // p-limit is an ESM from v4
          {
            'dependency-name': 'p-limit',
            versions: ['>= 4'],
          },
          // uuid is an ESM from v12
          {
            'dependency-name': 'uuid',
            versions: ['>= 12'],
          },
        ],
      },
      {
        'package-ecosystem': 'github-actions',
        directory: '/',
        schedule: {
          interval: 'weekly',
        },
        groups: {
          workflows: {
            patterns: ['*'],
          },
        },
      },
    ],
  };
  fs.writeFileSync(
    path.join(__dirname, '..', '.github', 'dependabot.yml'),
    `# Generated by .scripts/generate-dependabot-yml.js on 'npm run build'
# DO NOT EDIT THIS FILE

${yaml.dump(dependabot).toString('utf8')}`,
    'utf-8',
  );
};

export default generateDependabot;
