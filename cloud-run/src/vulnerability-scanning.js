const exec = require('@actions/exec');
const core = require('@actions/core');
const notifySlack = require('../../slack-notify/src/slack-notify');

const runImageScan = async (image, ignoreUnfixed) => {
  let output = '';
  await exec.exec(
    'trivy',
    ignoreUnfixed === true ? ['--timeout=300s', '--ignore-unfixed', '-o', 'scanReport.scan', image] : ['--timeout=300s', image],
    {
      silent: false,
      listeners: {
        stdout: (data) => {
          output += data.toString('utf8');
        },
      },
    },
  );
  return output;
};

const buildReport = async (scanResults, image) => {
  let results = [];
  for (let i = 0; i < scanResults.length; i += 1) {
    const line = scanResults[i];
    if (line.startsWith('Total:')) {
      results = line.match(/Total: ([0-9]+) \(UNKNOWN: ([0-9]+), LOW: ([0-9]+), MEDIUM: ([0-9]+), HIGH: ([0-9]+), CRITICAL: ([0-9]+)\)/);
    }
  }


  return {
    MESSAGE: `Total vulnerabilities found on ${image}: ${results[1]}
  Unknown: ${results[2]}
  Low: ${results[3]}
  Medium: ${results[4]}
  High: ${results[5]}
  Critical: ${results[6]}
  `,
    HIGH: results[5],
    CRITICAL: results[6],
  };
};

const installTrivy = async () => {
  await exec.exec('wget', [
    'https://github.com/aquasecurity/trivy/releases/download/v0.15.0/trivy_0.15.0_Linux-64bit.deb',
  ], {
    silent: true,
  });
  await exec.exec('sudo dpkg', [
    '-i',
    'trivy_0.15.0_Linux-64bit.deb',
  ], {
    silent: true,
  });
};

const scanImage = async (image, ignoreUnfixed) => {
  let rerunScan = false;
  let output = await runImageScan(image, ignoreUnfixed)
    .catch(() => {
      rerunScan = true;
    });
  // temporary fix, rerun scan on error
  if (rerunScan) {
    output = await runImageScan(image, ignoreUnfixed);
  }
  const scanResult = output.split(/[\r\n]+/);
  const report = await buildReport(scanResult, image);
  if (!ignoreUnfixed) {
    core.info(report);
    core.startGroup('full vulnerability scan report');
    core.info(output);
    core.endGroup();
  }
  return report;
};

const sendSlackAlert = async (serviceAccount, report) => {
  if (report.CRITICAL > 0 || report.HIGH > 0) {
    await notifySlack(serviceAccount, report.MESSAGE, '', 'scanReport.scan');
  }
};

const runScan = async (serviceAccount, image) => installTrivy()
  .then(() => scanImage(image, false)
    .then(() => scanImage(image, true)
      .then((report) => sendSlackAlert(serviceAccount, report))));

module.exports = runScan;
